<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SICO - Sistema Interno de Comunicación Organizacional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0;
      background: #f5f6fa;
      color: #222;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .app {
      max-width: 1080px;
      width: 100%;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      padding: 24px 32px 32px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      border-bottom: 1px solid #e2e4ea;
      padding-bottom: 12px;
      gap: 12px;
    }

    /* Marca: logo + texto */
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    .brand img {
      height: 36px;
      width: auto;
      display: block;
    }
    .brand .brand-text {
      font-weight: 800;
      font-size: 28px;
      color: #1664d8;
      letter-spacing: 1px;
    }

    h1 { font-size: 22px; margin: 0; }
    .subtitle { font-size: 14px; color: #666; margin-top: 4px; }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      margin-top: 16px;
    }
    .card {
      background: #fafbff;
      border-radius: 14px;
      padding: 18px 18px 20px;
      border: 1px solid #e2e4f0;
    }
    .card h2 { font-size: 16px; margin: 0 0 12px; }
    label { font-size: 14px; display: block; margin-bottom: 8px; cursor: pointer; }
    .radio-group { margin-top: 6px; }
    .radio-inline {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 10px;
    }
    .radio-inline input { margin-top: 3px; }
    .badge { display: inline-block; width: 12px; height: 12px; border-radius: 4px; margin-right: 6px; }
    .badge.rojo { background: #ff5252; }
    .badge.ambar { background: #ffb020; }
    .badge.azul { background: #2979ff; }
    .desc { font-size: 12px; color: #666; margin-top: -4px; margin-left: 22px; }

    .field { margin-top: 16px; }
    .field label { font-weight: 500; margin-bottom: 4px; }
    input[type="text"], input[type="password"], textarea, select, input[type="date"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d0d3e2;
      font-size: 14px;
      resize: vertical;
      min-height: 36px;
      background: #fff;
    }
    textarea { min-height: 110px; }

    .actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-sec { background: #eef1f8; color: #333; }
    .btn-primary { background: #1664d8; color: #fff; }
    .btn-danger { background: #f3d5d5; color: #7a1f1f; }
    .btn-primary:disabled { background: #9bb8ee; cursor: not-allowed; }

    .ticket {
      margin-top: 24px;
      background: #e8f4ff;
      border-radius: 14px;
      padding: 16px 18px;
      border: 1px solid #c7ddff;
      display: none;
    }
    .ticket h2 { font-size: 16px; margin: 0 0 8px; }
    .ticket p { margin: 0; font-size: 13px; }
    .ticket-code {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      background: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px dashed #88a8e5;
      display: inline-block;
      margin: 4px 0 10px;
    }
    .small-muted { font-size: 11px; color: #666; margin-top: 4px; }

    /* Vistas */
    #loginView, #formView, #adminView { display: none; }
    #loginView.active, #formView.active, #adminView.active { display: block; }

    .login-box {
      max-width: 420px;
      margin: 0 auto;
      padding: 24px 20px 10px;
    }
    .login-title { font-size: 20px; font-weight: 600; margin-bottom: 6px; }
    .login-sub { font-size: 13px; color: #666; margin-bottom: 18px; }
    .login-actions {
      margin-top: 18px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .error-msg {
      margin-top: 8px;
      font-size: 12px;
      color: #c62828;
      display: none;
    }

    /* Tabla RRHH */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #e1e4ec;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f5f7ff;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .03em;
    }
    tr:nth-child(even) td { background: #fafbff; }

    .estado-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      white-space: nowrap;
    }
    .estado-REGISTRADO { background: #fff3cd; color: #8a6d3b; }
    .estado-EN_REVISION { background: #d1ecf1; color: #0c5460; }
    .estado-ATENDIDO { background: #d4edda; color: #155724; }
    .estado-DERIVADO { background: #e2e3ff; color: #383d7c; }

    select.estadoSelect {
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid #c8cee0;
      background: #fff;
      min-height: 30px;
    }

    .btn-mini {
      padding: 2px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #c8cee0;
      background: #f5f7ff;
      cursor: pointer;
      white-space: nowrap;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .btn-mini:hover { background: #e1e6ff; }

    /* Badge conformidad */
    .conf-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .conf-PENDIENTE { background: #f1f3f9; color: #5b647b; }
    .conf-CONFORME { background: #e3f9e5; color: #256b38; }
    .conf-NO_CONFORME { background: #fff4e5; color: #8a4b16; }

    /* Vencimiento */
    .due-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
    }
    .due-ok { background: #e9f5ff; color: #0b4c87; }
    .due-soon { background: #fff4e5; color: #8a4b16; }
    .due-over { background: #fde8e8; color: #8a1f1f; }

    /* Opciones alineadas */
    .option-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .option-row input { margin: 0; }
    .option-row span { font-size: 14px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 999;
    }
    .modal {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.25);
      padding: 18px 18px 16px;
      border: 1px solid #e7e8f0;
    }
    .modal h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .modal p {
      margin: 0;
      font-size: 14px;
      color: #333;
      line-height: 1.35;
    }
    .modal-actions {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    @media (max-width: 640px) {
      .app { padding: 18px 16px 24px; }
      header { flex-direction: column; align-items: flex-start; gap: 10px; }
      table { font-size: 11px; }
      th, td { padding: 6px 4px; }
      .header-actions { width: 100%; justify-content: flex-start; }
    }
  </style>
</head>

<body>

<!-- ✅ MODAL CONFIRMACIÓN -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Mensaje</h3>
    <p id="modalMessage">...</p>
    <div class="modal-actions">
      <button class="btn-primary" id="modalCloseBtn" type="button">Cerrar</button>
    </div>
  </div>
</div>

<div class="app">

  <!-- HEADER -->
  <header>
    <div class="brand" id="brandHome" title="Volver al inicio">
      <img src="logoV2.png" alt="Logo SICO">
      <div class="brand-text">SICO</div>
    </div>

    <div style="flex:1; min-width: 240px;">
      <h1>Sistema Interno de Comunicación Organizacional</h1>
      <div class="subtitle">Banco de la Nación – Prototipo de registro y atención de comunicaciones.</div>
    </div>

    <div class="header-actions">
      <button class="btn-sec" id="btnInicio" type="button">Volver al inicio</button>
      <button class="btn-danger" id="btnLogout" type="button">Logout</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="loginView" class="active">
    <div class="login-box">
      <div class="login-title">Ingreso de usuario</div>
      <div class="login-sub">Use sus credenciales institucionales para ingresar.</div>

      <div class="field">
        <label for="loginUser">Usuario</label>
        <input type="text" id="loginUser" placeholder="Ej.: trabajador01 o rrhh01" />
      </div>

      <div class="field">
        <label for="loginPass">Contraseña</label>
        <input type="password" id="loginPass" placeholder="********" />
      </div>

      <div class="error-msg" id="loginError">
        Usuario o contraseña incorrectos. Intente nuevamente.
      </div>

      <div class="login-actions">
        <button class="btn-sec" id="loginClear" type="button">Limpiar</button>
        <button class="btn-primary" id="loginBtn" type="button">Ingresar</button>
      </div>
    </div>
  </section>

  <!-- TRABAJADOR -->
  <section id="formView">
    <h2 style="font-size:18px; margin: 0 0 12px;">Registro de sugerencias, reclamos y propuestas</h2>
    <div class="subtitle" style="margin-bottom:16px;">
      Complete la siguiente información. Su comunicación será derivada a Recursos Humanos.
    </div>

    <form id="sicoForm">
      <div class="grid">
        <div class="card">
          <h2>¿Cómo desea registrar su comunicación?</h2>
          <div class="radio-group">
            <div class="radio-inline">
              <input type="radio" id="anonimo" name="visibilidad" value="ANONIMO" required />
              <label for="anonimo">Anónima<br>
                <span class="desc">Su nombre no será mostrado al momento de la atención.</span>
              </label>
            </div>
            <div class="radio-inline">
              <input type="radio" id="publico" name="visibilidad" value="PUBLICO" />
              <label for="publico">Pública (mostrar mi nombre)<br>
                <span class="desc">Su nombre será visible para el área que atienda el caso.</span>
              </label>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Seleccione el nivel de urgencia</h2>
          <div class="radio-group">
            <div class="radio-inline">
              <input type="radio" id="urgente" name="urgencia" value="ALTA" required />
              <label for="urgente">
                <span class="badge rojo"></span>Urgente
                <div class="desc">(requiere atención inmediata)</div>
              </label>
            </div>
            <div class="radio-inline">
              <input type="radio" id="media" name="urgencia" value="MEDIA" />
              <label for="media">
                <span class="badge ambar"></span>Media
                <div class="desc">(requiere atención en 48 horas)</div>
              </label>
            </div>
            <div class="radio-inline">
              <input type="radio" id="baja" name="urgencia" value="BAJA" />
              <label for="baja">
                <span class="badge azul"></span>Baja
                <div class="desc">(puede ser atendido dentro del mes)</div>
              </label>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>¿Qué desea registrar?</h2>
          <div class="radio-group">
            <div class="radio-inline">
              <input type="radio" id="sugerencia" name="tipo" value="SUGERENCIA" required />
              <label for="sugerencia">Sugerencia
                <div class="desc">Idea para mejorar un proceso, ambiente o práctica.</div>
              </label>
            </div>
            <div class="radio-inline">
              <input type="radio" id="reclamo" name="tipo" value="RECLAMO" />
              <label for="reclamo">Reclamo
                <div class="desc">Problema específico que afecta su trabajo o bienestar.</div>
              </label>
            </div>
            <div class="radio-inline">
              <input type="radio" id="propuesta" name="tipo" value="PROPUESTA" />
              <label for="propuesta">Propuesta
                <div class="desc">Alternativa o planteamiento para resolver una situación.</div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Fecha límite (nuevo) -->
      <div class="field">
        <label for="fechaLimite">Fecha límite de respuesta</label>
        <input type="date" id="fechaLimite" name="fechaLimite" required />
        <div class="small-muted">No se permiten fechas pasadas. Seleccione una fecha desde hoy en adelante.</div>
      </div>

      <div class="field">
        <label for="titulo">Título de la comunicación</label>
        <input type="text" id="titulo" name="titulo" maxlength="120" required
               placeholder="Ej.: Propuesta para mejorar la rotación de turnos" />
      </div>

      <div class="field">
        <label for="detalle">Detalle / descripción</label>
        <textarea id="detalle" name="detalle" required
                  placeholder="Describa brevemente la situación, sugerencia o propuesta..."></textarea>
        <div class="small-muted">Evite incluir datos sensibles innecesarios. Sea concreto y respetuoso.</div>
      </div>

      <div class="actions">
        <button type="button" class="btn-sec" id="limpiarBtn">Limpiar</button>
        <button type="submit" class="btn-primary" id="enviarBtn">Enviar comunicación</button>
      </div>
    </form>

    <div class="ticket" id="ticketBox">
      <h2>✅ Comunicación registrada correctamente</h2>
      <p>Su número de seguimiento es:</p>
      <div class="ticket-code" id="ticketCode"></div>
      <p>Podrá utilizar este código si necesita hacer seguimiento con Recursos Humanos.</p>
      <p class="small-muted" id="ticketMeta"></p>
    </div>

    <div id="misComunicaciones" class="card" style="margin-top:24px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div>
          <h2 style="font-size:16px; margin:0 0 6px;">Mis comunicaciones</h2>
          <div class="subtitle" style="margin-bottom:8px;">
            Revise el estado de sus comunicaciones y registre su conformidad cuando corresponda.
          </div>
        </div>
        <button class="btn-sec" id="refrescarMisBtn" type="button">Actualizar</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Fecha</th>
            <th>Fecha límite</th>
            <th>Tipo</th>
            <th>Urgencia</th>
            <th>Estado</th>
            <th>Conformidad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaMisTickets"></tbody>
      </table>

      <div class="small-muted" style="margin-top:8px;">
        Solo se muestran las comunicaciones registradas con su usuario actual.
      </div>
    </div>

    <div id="panelConformidad" class="card" style="margin-top:16px; display:none;">
      <h3 style="margin:0 0 8px; font-size:15px;">Conformidad de atención</h3>
      <div class="small-muted" id="panelConformidadInfo"></div>

      <div class="field" style="margin-top:12px;">
        <div class="option-row">
          <input type="radio" name="conformidad" value="CONFORME" id="conf_ok">
          <span>Estoy conforme con la atención recibida</span>
        </div>
        <div class="option-row">
          <input type="radio" name="conformidad" value="NO_CONFORME" id="conf_no">
          <span>No estoy conforme, deseo dejar un comentario</span>
        </div>
      </div>

      <div class="field" id="campoComentarioConformidad" style="display:none;">
        <label for="comentarioConformidad">Comentario</label>
        <textarea id="comentarioConformidad"
                  placeholder="Describa brevemente por qué no está conforme o qué espera que se revise..."></textarea>
      </div>

      <div class="actions">
        <button type="button" class="btn-sec" id="cancelarConformidad">Cancelar</button>
        <button type="button" class="btn-primary" id="guardarConformidad">Guardar conformidad</button>
      </div>

      <div class="small-muted" id="panelConformidadMsg" style="margin-top:8px;"></div>
    </div>
  </section>

  <!-- RRHH -->
  <section id="adminView">
    <div class="admin-header">
      <div>
        <h2 style="font-size:18px; margin:0 0 4px;">Panel de RRHH – Evaluación y atención</h2>
        <div class="subtitle">Revise las comunicaciones, fecha límite, estado y atienda/derive.</div>
      </div>
      <button class="btn-sec" id="refrescarBtn" type="button">Actualizar lista</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:10px; flex-wrap:wrap;">
      <div class="subtitle">Filtros y seguimiento</div>
      <div style="display:flex; align-items:center; gap:8px;">
        <label for="filtroConformidadAdmin" class="subtitle" style="margin:0;">Filtrar por conformidad:</label>
        <select id="filtroConformidadAdmin" style="min-width: 160px;">
          <option value="TODOS">Todos</option>
          <option value="PENDIENTE">Pendiente</option>
          <option value="CONFORME">Conforme</option>
          <option value="NO_CONFORME">No conforme</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Fecha</th>
          <th>Fecha límite</th>
          <th>Usuario</th>
          <th>Tipo</th>
          <th>Urgencia</th>
          <th>Visibilidad</th>
          <th>Estado</th>
          <th>Conformidad</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaTickets"></tbody>
    </table>

    <div id="panelDetalleTicket" class="card" style="margin-top:16px; display:none;">
      <h3 style="margin:0 0 8px; font-size:15px;">Detalle de la comunicación</h3>
      <div class="small-muted" id="detalleTicketInfo"></div>

      <div class="field">
        <label>Título</label>
        <div id="detalleTicketTitulo" style="font-size:14px; font-weight:600;"></div>
      </div>

      <div class="field">
        <label>Detalle / descripción</label>
        <div id="detalleTicketDetalle" style="white-space:pre-line; font-size:14px;"></div>
      </div>

      <div class="field" id="detalleTicketRespuestaWrap" style="display:none;">
        <label>Respuesta / Derivación</label>
        <div id="detalleTicketRespuesta" style="white-space:pre-line; font-size:14px;"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn-sec" id="cerrarDetalleTicket">Cerrar</button>
      </div>
    </div>

    <div id="panelAtencion" class="card" style="margin-top:16px; display:none;">
      <h3 style="margin:0 0 8px; font-size:15px;">Atender comunicación</h3>
      <div class="small-muted" id="panelAtencionInfo"></div>

      <div class="field" style="margin-top:12px;">
        <div class="option-row">
          <input type="radio" name="modoAtencion" value="RESPONDER" id="modo_resp">
          <span>Responder</span>
        </div>
        <div class="option-row">
          <input type="radio" name="modoAtencion" value="DERIVAR" id="modo_der">
          <span>Derivar a otra área</span>
        </div>
      </div>

      <div class="field" id="panelRespuesta" style="display:none;">
        <label for="textoRespuesta">Respuesta para el trabajador</label>
        <textarea id="textoRespuesta" placeholder="Redacte la respuesta..."></textarea>
      </div>

      <div class="field" id="panelDerivar" style="display:none;">
        <label for="areaDerivar">Seleccione el área de destino</label>
        <select id="areaDerivar">
          <option value="">Seleccione un área...</option>
          <option value="Administración de personal">Administración de personal</option>
          <option value="Tecnología e información">Tecnología e información</option>
          <option value="Comercial">Comercial</option>
          <option value="Atención al cliente">Atención al cliente</option>
        </select>
      </div>

      <div class="actions">
        <button type="button" class="btn-sec" id="cancelarAtencion">Cancelar</button>
        <button type="button" class="btn-primary" id="guardarAtencion">Guardar y enviar</button>
      </div>

      <div class="small-muted" id="panelAtencionMsg" style="margin-top:8px;"></div>
    </div>

    <div id="panelDetalleConformidad" class="card" style="margin-top:16px; display:none;">
      <h3 style="margin:0 0 8px; font-size:15px;">Detalle de conformidad del trabajador</h3>
      <div class="small-muted" id="detalleConformidadInfo"></div>
      <p id="detalleConformidadTexto" style="margin-top:8px; white-space:pre-line;"></p>

      <div class="actions">
        <button type="button" class="btn-sec" id="cerrarDetalleConformidad">Cerrar</button>
      </div>
    </div>

    <div class="small-muted" style="margin-top:8px;">
      *Prototipo: datos almacenados en localStorage del navegador.
    </div>
  </section>

</div>

<script>
  // =========================
  // MODAL (reutilizable)
  // =========================
  const modalOverlay = document.getElementById('modalOverlay');
  const modalMessage = document.getElementById('modalMessage');
  const modalCloseBtn = document.getElementById('modalCloseBtn');

  function abrirModal(msg) {
    modalMessage.textContent = msg;
    modalOverlay.style.display = 'flex';
    modalCloseBtn.focus();
  }
  function cerrarModal() {
    modalOverlay.style.display = 'none';
  }

  modalCloseBtn.addEventListener('click', cerrarModal);
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) cerrarModal();
  });

  // =========================
  // VISTAS + NAV
  // =========================
  const loginView = document.getElementById('loginView');
  const formView  = document.getElementById('formView');
  const adminView = document.getElementById('adminView');

  const brandHome = document.getElementById('brandHome');
  const btnInicio = document.getElementById('btnInicio');
  const btnLogout = document.getElementById('btnLogout');

  function mostrarVistaLogin() {
    loginView.classList.add('active');
    formView.classList.remove('active');
    adminView.classList.remove('active');
  }

  function mostrarVistaTrabajador() {
    loginView.classList.remove('active');
    adminView.classList.remove('active');
    formView.classList.add('active');
    panelConformidad.style.display = 'none';
    ticketBox.style.display = 'none';
    cargarMisTickets();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function mostrarVistaRRHH() {
    loginView.classList.remove('active');
    formView.classList.remove('active');
    adminView.classList.add('active');
    cargarTicketsEnTabla();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function getSesion() {
    return {
      usuario: localStorage.getItem('sicoUsuario') || '',
      rol: localStorage.getItem('sicoRol') || ''
    };
  }

  function irInicioSegunRol() {
    const s = getSesion();
    if (!s.usuario || !s.rol) return mostrarVistaLogin();
    if (s.rol === 'TRABAJADOR') return mostrarVistaTrabajador();
    if (s.rol === 'RRHH') return mostrarVistaRRHH();
    mostrarVistaLogin();
  }

  function logout() {
    localStorage.removeItem('sicoUsuario');
    localStorage.removeItem('sicoRol');
    mostrarVistaLogin();
  }

  brandHome.addEventListener('click', irInicioSegunRol);
  btnInicio.addEventListener('click', irInicioSegunRol);
  btnLogout.addEventListener('click', logout);

  // =========================
  // LOGIN
  // =========================
  const loginUser  = document.getElementById('loginUser');
  const loginPass  = document.getElementById('loginPass');
  const loginBtn   = document.getElementById('loginBtn');
  const loginClear = document.getElementById('loginClear');
  const loginError = document.getElementById('loginError');

  const usuariosDemo = [
    { usuario: 'trabajador01', pass: '1234', rol: 'TRABAJADOR' },
    { usuario: 'trabajador02', pass: '1234', rol: 'TRABAJADOR' },
    { usuario: 'trabajador03', pass: '1234', rol: 'TRABAJADOR' },
    { usuario: 'trabajador04', pass: '1234', rol: 'TRABAJADOR' },
    { usuario: 'trabajador05', pass: '1234', rol: 'TRABAJADOR' },
    { usuario: 'rrhh01',       pass: '1234', rol: 'RRHH' },
  ];

  function buscarUsuario(u, p) {
    return usuariosDemo.find(item => item.usuario === u && item.pass === p) || null;
  }

  loginBtn.addEventListener('click', () => {
    const u = loginUser.value.trim();
    const p = loginPass.value.trim();

    if (!u || !p) {
      loginError.textContent = 'Ingrese usuario y contraseña.';
      loginError.style.display = 'block';
      return;
    }

    const usuario = buscarUsuario(u, p);
    if (usuario) {
      loginError.style.display = 'none';
      localStorage.setItem('sicoUsuario', usuario.usuario);
      localStorage.setItem('sicoRol', usuario.rol);

      if (usuario.rol === 'TRABAJADOR') mostrarVistaTrabajador();
      else mostrarVistaRRHH();
    } else {
      loginError.textContent = 'Usuario o contraseña incorrectos. Intente nuevamente.';
      loginError.style.display = 'block';
    }
  });

  loginClear.addEventListener('click', () => {
    loginUser.value = '';
    loginPass.value = '';
    loginError.style.display = 'none';
    loginUser.focus();
  });

  // ✅ iniciar en login
  mostrarVistaLogin();

  // =========================
  // HELPERS FECHA
  // =========================
  function hoyISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function parseISODate(iso) {
    // iso: YYYY-MM-DD
    const [y, m, d] = (iso || '').split('-').map(n => parseInt(n, 10));
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d, 0, 0, 0, 0);
  }

  function formatFechaES(iso) {
    const dt = parseISODate(iso);
    if (!dt) return '-';
    return dt.toLocaleDateString('es-PE');
  }

  function diffDias(iso) {
    const dt = parseISODate(iso);
    if (!dt) return null;
    const hoy = parseISODate(hoyISO());
    const ms = dt.getTime() - hoy.getTime();
    return Math.round(ms / (1000 * 60 * 60 * 24));
  }

  function badgeVencimiento(iso) {
    const d = diffDias(iso);
    if (d === null) return `<span class="due-badge due-ok">Sin fecha</span>`;
    if (d < 0) return `<span class="due-badge due-over">⛔ Vencido</span>`;
    if (d <= 1) return `<span class="due-badge due-soon">⚠️ Por vencer</span>`;
    return `<span class="due-badge due-ok">En plazo</span>`;
  }

  // =========================
  // STORAGE
  // =========================
  function generarCodigo() {
    const ahora = new Date();
    const año = ahora.getFullYear();
    const rand = Math.floor(Math.random() * 9000) + 1000;
    return `SICO-${año}-${rand}`;
  }

  function obtenerTickets() {
    return JSON.parse(localStorage.getItem('sicoTickets') || '[]');
  }

  function guardarTickets(lista) {
    localStorage.setItem('sicoTickets', JSON.stringify(lista));
  }

  function guardarEnLocalStorage(ticket) {
    const existentes = obtenerTickets();
    existentes.push(ticket);
    guardarTickets(existentes);
  }

  // =========================
  // ETAPA 1: REGISTRO
  // =========================
  const form          = document.getElementById('sicoForm');
  const ticketBox     = document.getElementById('ticketBox');
  const ticketCodeEl  = document.getElementById('ticketCode');
  const ticketMetaEl  = document.getElementById('ticketMeta');
  const limpiarBtn    = document.getElementById('limpiarBtn');
  const fechaLimiteInput = document.getElementById('fechaLimite');

  // ✅ bloquear fechas pasadas
  const minHoy = hoyISO();
  fechaLimiteInput.min = minHoy;

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const data = new FormData(form);
    const visibilidad = data.get('visibilidad');
    const urgencia    = data.get('urgencia');
    const tipo        = data.get('tipo');
    const fechaLimite = (data.get('fechaLimite') || '').trim();
    const titulo      = (data.get('titulo') || '').trim();
    const detalle     = (data.get('detalle') || '').trim();
    const usuarioSesion = localStorage.getItem('sicoUsuario') || 'ANON';

    if (!visibilidad || !urgencia || !tipo || !titulo || !detalle || !fechaLimite) {
      alert('Por favor complete todos los campos (incluida la fecha límite).');
      return;
    }

    // ✅ validación extra (si intentan una fecha pasada)
    const hoy = parseISODate(hoyISO());
    const dtLim = parseISODate(fechaLimite);
    if (!dtLim || dtLim.getTime() < hoy.getTime()) {
      alert('La fecha límite no puede ser anterior a hoy.');
      return;
    }

    const codigo = generarCodigo();
    const fecha  = new Date().toLocaleString('es-PE');

    const ticket = {
      codigo, fecha, visibilidad, urgencia, tipo,
      fechaLimite, // ✅ nuevo
      titulo, detalle,
      usuario: usuarioSesion,
      estado: 'REGISTRADO',
      conformidad: null,
      comentarioConformidad: '',
      respuesta: '',
      areaDerivada: ''
    };

    guardarEnLocalStorage(ticket);

    ticketCodeEl.textContent = codigo;
    ticketMetaEl.textContent =
      `Registrado el ${fecha} – Límite: ${formatFechaES(fechaLimite)} – Tipo: ${tipo}, Urgencia: ${urgencia}, Usuario: ${usuarioSesion}`;

    ticketBox.style.display = 'block';
    form.reset();

    // volver a setear min y dejar fecha vacía
    fechaLimiteInput.min = minHoy;

    cargarMisTickets();
  });

  limpiarBtn.addEventListener('click', () => {
    if (confirm('¿Desea limpiar el formulario?')) {
      form.reset();
      fechaLimiteInput.min = minHoy;
    }
  });

  // =========================
  // ETAPA 3: Mis comunicaciones
  // =========================
  const refrescarMisBtn            = document.getElementById('refrescarMisBtn');
  const tablaMisTickets            = document.getElementById('tablaMisTickets');
  const panelConformidad           = document.getElementById('panelConformidad');
  const panelConformidadInfo       = document.getElementById('panelConformidadInfo');
  const panelConformidadMsg        = document.getElementById('panelConformidadMsg');
  const campoComentarioConformidad = document.getElementById('campoComentarioConformidad');
  const comentarioConformidad      = document.getElementById('comentarioConformidad');
  const guardarConformidad         = document.getElementById('guardarConformidad');
  const cancelarConformidad        = document.getElementById('cancelarConformidad');

  let indiceConformidad = null;
  let onModalClose = null;

  function textoConformidad(t) {
    if (!t.conformidad) return 'Pendiente';
    if (t.conformidad === 'CONFORME') return 'Conforme';
    if (t.conformidad === 'NO_CONFORME') return 'No conforme';
    return t.conformidad;
  }

  function cargarMisTickets() {
    const usuarioSesion = localStorage.getItem('sicoUsuario');
    if (!usuarioSesion || !tablaMisTickets) return;

    const tickets = obtenerTickets();
    tablaMisTickets.innerHTML = '';

    let tiene = false;
    tickets.forEach((t, idx) => {
      if (t.usuario !== usuarioSesion) return;
      tiene = true;

      const puedeRevisar = (t.estado === 'ATENDIDO' || t.estado === 'DERIVADO');
      const yaCalifico = !!t.conformidad;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t.codigo}</td>
        <td>${t.fecha}</td>
        <td>
          ${formatFechaES(t.fechaLimite)}
          <div class="small-muted">${badgeVencimiento(t.fechaLimite)}</div>
        </td>
        <td>${t.tipo}</td>
        <td>${t.urgencia}</td>
        <td>${t.estado}</td>
        <td>${textoConformidad(t)}</td>
        <td>
          ${
            puedeRevisar
              ? (
                  yaCalifico
                    ? '<span class="small-muted">Registrada</span>'
                    : `<button type="button" class="btn-mini conformidadBtn" data-index="${idx}">Revisar</button>`
                )
              : '<span class="small-muted">En proceso</span>'
          }
        </td>
      `;
      tablaMisTickets.appendChild(tr);
    });

    if (!tiene) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="8">Aún no ha registrado comunicaciones.</td>`;
      tablaMisTickets.appendChild(tr);
    }
  }

  refrescarMisBtn.addEventListener('click', cargarMisTickets);

  guardarConformidad.addEventListener('click', () => {
    if (indiceConformidad === null) return;

    const seleccion = document.querySelector('input[name="conformidad"]:checked');
    if (!seleccion) return alert('Seleccione si está conforme o no con la atención.');

    const tickets = obtenerTickets();
    const t = tickets[indiceConformidad];
    if (!t) return;

    // ✅ bloquear doble registro
    if (t.conformidad) {
      abrirModal('Su conformidad ya fue registrada anteriormente.');
      return;
    }

    t.conformidad = seleccion.value;

    if (seleccion.value === 'NO_CONFORME') {
      const comentario = comentarioConformidad.value.trim();
      if (!comentario) return alert('Ingrese un comentario para "No conforme".');
      t.comentarioConformidad = comentario;
    } else {
      t.comentarioConformidad = '';
    }

    guardarTickets(tickets);

    // ✅ Modal + al cerrar: ocultar panel y refrescar lista
    onModalClose = () => {
      panelConformidad.style.display = 'none';
      indiceConformidad = null;
      cargarMisTickets();
    };

    abrirModal('Su conformidad ha sido registrada. ¡Gracias!');
  });

  // cuando cierras el modal: ejecutar callback si existe
  function cerrarModalConCallback() {
    cerrarModal();
    if (typeof onModalClose === 'function') {
      const fn = onModalClose;
      onModalClose = null;
      fn();
    }
  }
  // reemplaza handler del botón cerrar para usar callback
  modalCloseBtn.removeEventListener('click', cerrarModal);
  modalCloseBtn.addEventListener('click', cerrarModalConCallback);

  // clic fuera del modal también cierra con callback
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) cerrarModalConCallback();
  });

  cancelarConformidad.addEventListener('click', () => {
    panelConformidad.style.display = 'none';
    indiceConformidad = null;
  });

  // =========================
  // RRHH
  // =========================
  const tablaTickets = document.getElementById('tablaTickets');
  const refrescarBtn = document.getElementById('refrescarBtn');
  const filtroConformidadAdmin = document.getElementById('filtroConformidadAdmin');

  const panelAtencion     = document.getElementById('panelAtencion');
  const panelAtencionInfo = document.getElementById('panelAtencionInfo');
  const panelAtencionMsg  = document.getElementById('panelAtencionMsg');
  const panelRespuesta    = document.getElementById('panelRespuesta');
  const panelDerivar      = document.getElementById('panelDerivar');
  const textoRespuesta    = document.getElementById('textoRespuesta');
  const areaDerivar       = document.getElementById('areaDerivar');
  const guardarAtencion   = document.getElementById('guardarAtencion');
  const cancelarAtencion  = document.getElementById('cancelarAtencion');

  const panelDetalleConformidad = document.getElementById('panelDetalleConformidad');
  const detalleConformidadInfo  = document.getElementById('detalleConformidadInfo');
  const detalleConformidadTexto = document.getElementById('detalleConformidadTexto');
  const cerrarDetalleConformidadBtn = document.getElementById('cerrarDetalleConformidad');

  const panelDetalleTicket = document.getElementById('panelDetalleTicket');
  const detalleTicketInfo  = document.getElementById('detalleTicketInfo');
  const detalleTicketTitulo = document.getElementById('detalleTicketTitulo');
  const detalleTicketDetalle = document.getElementById('detalleTicketDetalle');
  const detalleTicketRespuestaWrap = document.getElementById('detalleTicketRespuestaWrap');
  const detalleTicketRespuesta = document.getElementById('detalleTicketRespuesta');
  const cerrarDetalleTicketBtn = document.getElementById('cerrarDetalleTicket');

  let indiceEnAtencion = null;

  function badgeEstado(estado) {
    const safe = estado || 'REGISTRADO';
    return `<span class="estado-badge estado-${safe}">${safe.replace('_', ' ')}</span>`;
  }

  function badgeConformidad(t) {
    const conf = t.conformidad ? t.conformidad : 'PENDIENTE';
    const txt  = textoConformidad(t);
    return `<span class="conf-badge conf-${conf}">${txt}</span>`;
  }

  function usuarioMostrable(t) {
    return t.visibilidad === 'ANONIMO' ? 'Anónimo' : (t.usuario || '');
  }

  function cerrarPanelesRRHH() {
    panelAtencion.style.display = 'none';
    panelDetalleConformidad.style.display = 'none';
    panelDetalleTicket.style.display = 'none';
    indiceEnAtencion = null;
  }

  function cargarTicketsEnTabla() {
    const tickets = obtenerTickets();
    tablaTickets.innerHTML = '';
    cerrarPanelesRRHH();

    const filtro = filtroConformidadAdmin ? filtroConformidadAdmin.value : 'TODOS';

    if (tickets.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="10">No hay comunicaciones registradas.</td>`;
      tablaTickets.appendChild(tr);
      return;
    }

    // ✅ sugerencia: ordenar por fecha límite asc (más cercano primero)
    tickets
      .map((t, idx) => ({ t, idx }))
      .sort((a, b) => {
        const da = parseISODate(a.t.fechaLimite)?.getTime() || 0;
        const db = parseISODate(b.t.fechaLimite)?.getTime() || 0;
        return da - db;
      })
      .forEach(({ t, idx }) => {
        const confTxt = textoConformidad(t);
        if (filtro === 'PENDIENTE' && confTxt !== 'Pendiente') return;
        if (filtro === 'CONFORME' && confTxt !== 'Conforme') return;
        if (filtro === 'NO_CONFORME' && confTxt !== 'No conforme') return;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.codigo}</td>
          <td>${t.fecha}</td>
          <td>
            ${formatFechaES(t.fechaLimite)}
            <div class="small-muted">${badgeVencimiento(t.fechaLimite)}</div>
          </td>
          <td>${usuarioMostrable(t)}</td>
          <td>${t.tipo}</td>
          <td>${t.urgencia}</td>
          <td>${t.visibilidad}</td>
          <td>${badgeEstado(t.estado)}</td>
          <td>
            ${badgeConformidad(t)}
            ${
              t.conformidad === 'NO_CONFORME' && t.comentarioConformidad
                ? `<button type="button" class="btn-mini verConformidadBtn" data-index="${idx}">Ver</button>`
                : ''
            }
          </td>
          <td>
            <button type="button" class="btn-mini verDetalleBtn" data-index="${idx}">Ver detalle</button>
            <button type="button" class="btn-mini atenderBtn" data-index="${idx}">Atender</button>
            <div>
              <select class="estadoSelect" data-index="${idx}">
                <option value="REGISTRADO" ${t.estado === 'REGISTRADO' ? 'selected' : ''}>Registrado</option>
                <option value="EN_REVISION" ${t.estado === 'EN_REVISION' ? 'selected' : ''}>En revisión</option>
                <option value="ATENDIDO"   ${t.estado === 'ATENDIDO'   ? 'selected' : ''}>Atendido</option>
                <option value="DERIVADO"   ${t.estado === 'DERIVADO'   ? 'selected' : ''}>Derivado</option>
              </select>
            </div>
          </td>
        `;
        tablaTickets.appendChild(tr);
      });

    // Si no queda nada visible por filtro
    if (tablaTickets.children.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="10">No hay comunicaciones que coincidan con el filtro.</td>`;
      tablaTickets.appendChild(tr);
    }
  }

  refrescarBtn.addEventListener('click', cargarTicketsEnTabla);
  filtroConformidadAdmin.addEventListener('change', cargarTicketsEnTabla);

  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('estadoSelect')) {
      const idx = parseInt(e.target.dataset.index, 10);
      const nuevo = e.target.value;
      const tickets = obtenerTickets();
      if (tickets[idx]) {
        tickets[idx].estado = nuevo;
        guardarTickets(tickets);
        cargarTicketsEnTabla();
      }
    }

    if (e.target.name === 'modoAtencion') {
      if (e.target.value === 'RESPONDER') {
        panelRespuesta.style.display = 'block';
        panelDerivar.style.display = 'none';
      } else {
        panelRespuesta.style.display = 'none';
        panelDerivar.style.display = 'block';
      }
    }

    if (e.target.name === 'conformidad') {
      campoComentarioConformidad.style.display = (e.target.value === 'NO_CONFORME') ? 'block' : 'none';
    }
  });

  document.addEventListener('click', (e) => {
    // Abrir panel conformidad trabajador
    if (e.target.classList.contains('conformidadBtn')) {
      const idx = parseInt(e.target.dataset.index, 10);
      const tickets = obtenerTickets();
      const t = tickets[idx];
      if (!t) return;

      // no permitir si ya registró
      if (t.conformidad) {
        abrirModal('Su conformidad ya fue registrada anteriormente.');
        return;
      }

      indiceConformidad = idx;
      panelConformidad.style.display = 'block';
      panelConformidadMsg.textContent = '';
      comentarioConformidad.value = '';
      campoComentarioConformidad.style.display = 'none';
      document.querySelectorAll('input[name="conformidad"]').forEach(r => r.checked = false);

      let detalleResp = '';
      if (t.respuesta) detalleResp = `Respuesta de RRHH: "${t.respuesta}"`;
      else if (t.areaDerivada) detalleResp = `Derivado al área: ${t.areaDerivada}.`;

      panelConformidadInfo.textContent =
        `${t.codigo} – ${t.tipo} – Estado: ${t.estado} – Límite: ${formatFechaES(t.fechaLimite)}. ${detalleResp}`;

      window.scrollTo({ top: panelConformidad.offsetTop - 80, behavior: 'smooth' });
    }

    // Ver detalle RRHH
    if (e.target.classList.contains('verDetalleBtn')) {
      const idx = parseInt(e.target.dataset.index, 10);
      const tickets = obtenerTickets();
      const t = tickets[idx];
      if (!t) return;

      cerrarPanelesRRHH();
      panelDetalleTicket.style.display = 'block';

      detalleTicketInfo.textContent =
        `${t.codigo} – ${t.tipo} – ${t.urgencia} – Usuario: ${usuarioMostrable(t)} – Estado: ${t.estado} – Límite: ${formatFechaES(t.fechaLimite)}`;

      detalleTicketTitulo.textContent = t.titulo || '(Sin título)';
      detalleTicketDetalle.textContent = t.detalle || '(Sin detalle)';

      let extra = '';
      if (t.respuesta) extra = `Respuesta de RRHH:\n${t.respuesta}`;
      else if (t.areaDerivada) extra = `Derivado al área: ${t.areaDerivada}.`;

      if (extra) {
        detalleTicketRespuestaWrap.style.display = 'block';
        detalleTicketRespuesta.textContent = extra;
      } else {
        detalleTicketRespuestaWrap.style.display = 'none';
        detalleTicketRespuesta.textContent = '';
      }

      window.scrollTo({ top: panelDetalleTicket.offsetTop - 80, behavior: 'smooth' });
    }

    // Atender RRHH
    if (e.target.classList.contains('atenderBtn')) {
      const idx = parseInt(e.target.dataset.index, 10);
      const tickets = obtenerTickets();
      const t = tickets[idx];
      if (!t) return;

      cerrarPanelesRRHH();
      indiceEnAtencion = idx;
      panelAtencion.style.display = 'block';

      panelAtencionMsg.textContent = '';
      textoRespuesta.value = '';
      areaDerivar.value = '';
      document.querySelectorAll('input[name="modoAtencion"]').forEach(r => r.checked = false);
      panelRespuesta.style.display = 'none';
      panelDerivar.style.display = 'none';

      panelAtencionInfo.textContent =
        `${t.codigo} – ${t.tipo} – ${t.urgencia} – ${usuarioMostrable(t)} – Límite: ${formatFechaES(t.fechaLimite)}`;

      window.scrollTo({ top: panelAtencion.offsetTop - 80, behavior: 'smooth' });
    }

    // Ver comentario No conforme RRHH
    if (e.target.classList.contains('verConformidadBtn')) {
      const idx = parseInt(e.target.dataset.index, 10);
      const tickets = obtenerTickets();
      const t = tickets[idx];
      if (!t) return;

      cerrarPanelesRRHH();
      panelDetalleConformidad.style.display = 'block';

      detalleConformidadInfo.textContent =
        `${t.codigo} – ${t.tipo} – Estado: ${t.estado} – Conformidad: ${textoConformidad(t)}`;

      detalleConformidadTexto.textContent =
        t.comentarioConformidad ? t.comentarioConformidad : 'Marcó "No conforme" pero no dejó comentario.';

      window.scrollTo({ top: panelDetalleConformidad.offsetTop - 80, behavior: 'smooth' });
    }
  });

  guardarAtencion.addEventListener('click', () => {
    if (indiceEnAtencion === null) return;

    const modo = document.querySelector('input[name="modoAtencion"]:checked');
    if (!modo) return alert('Seleccione si va a responder o derivar.');

    const tickets = obtenerTickets();
    const t = tickets[indiceEnAtencion];
    if (!t) return;

    if (modo.value === 'RESPONDER') {
      const txt = textoRespuesta.value.trim();
      if (!txt) return alert('Ingrese la respuesta.');
      t.respuesta = txt;
      t.areaDerivada = '';
      t.estado = 'ATENDIDO';
      panelAtencionMsg.textContent = 'Se ha atendido la comunicación.';
    } else {
      const area = areaDerivar.value;
      if (!area) return alert('Seleccione el área.');
      t.areaDerivada = area;
      t.respuesta = '';
      t.estado = 'DERIVADO';
      panelAtencionMsg.textContent = `Se ha derivado la comunicación al área de ${area}.`;
    }

    guardarTickets(tickets);
    cargarTicketsEnTabla();
  });

  cancelarAtencion.addEventListener('click', cerrarPanelesRRHH);
  cerrarDetalleConformidadBtn.addEventListener('click', () => panelDetalleConformidad.style.display = 'none');
  cerrarDetalleTicketBtn.addEventListener('click', () => panelDetalleTicket.style.display = 'none');

  // =========================
  // Navegación (inicio/logout)
  // =========================
  function getSesion() {
    return {
      usuario: localStorage.getItem('sicoUsuario') || '',
      rol: localStorage.getItem('sicoRol') || ''
    };
  }

  function irInicioSegunRol() {
    const s = getSesion();
    if (!s.usuario || !s.rol) return mostrarVistaLogin();
    if (s.rol === 'TRABAJADOR') return mostrarVistaTrabajador();
    if (s.rol === 'RRHH') return mostrarVistaRRHH();
    mostrarVistaLogin();
  }

  function logout() {
    localStorage.removeItem('sicoUsuario');
    localStorage.removeItem('sicoRol');
    mostrarVistaLogin();
  }

  // botones ya referenciados arriba
  // brandHome, btnInicio, btnLogout
  // (ya tienen listeners, pero por seguridad re-asignamos si la app se reusa)
  // Nota: no duplicamos listeners aquí para evitar dobles acciones.

</script>
</body>
</html>
